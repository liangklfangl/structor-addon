"use strict";function _interopRequireWildcard(t){if(t&&t.__esModule)return t;var n={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r]);return n.default=t,n}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function downloadDistr(t){var n=_structorCommons.config.getProjectDir();return client.download(t).then(function(r){var e=_path2.default.join(n,"__metaDistr.tar.gz").replace(/\\/g,"/"),o=_path2.default.join(n,META_DISTR_DIR_NAME).replace(/\\/g,"/");return _structorCommons.commons.writeBinaryFile(e,r).then(function(){return _structorCommons.commons.unpackTarGz(e,o)}).then(function(){return _structorCommons.commons.readDirectoryFlat(o).then(function(n){if(n){var r=n.dirs;if(r&&1===r.length)return r[0].path}throw _structorCommons.commons.removeFile(e),Error("Downloaded tarball has wrong structure. Check the ulr: "+t)})}).then(function(t){return _structorCommons.commons.removeFile(e).then(function(){return{innerDirPath:t,tempDirPath:o}})})})}function cleanDistr(){var t=_path2.default.join(_structorCommons.config.getProjectDir(),META_DISTR_DIR_NAME);return _structorCommons.commons.isExisting(t).then(function(){return _structorCommons.commons.removeFile(t)}).catch(function(t){})}function preInstall(t,n){var r=[],e=void 0,o=void 0,s=void 0,i=void 0,u=void 0;return t?(e=t,u=Promise.resolve()):n&&(u=downloadDistr(n).then(function(t){e=t.innerDirPath})),u.then(function(){return o=_path2.default.join(e,"modules"),_structorCommons.commons.readJson(_path2.default.join(e,"structor-namespaces.json"))}).then(function(t){s=t}).then(function(){return _structorCommons.storage.getComponentTree().then(function(t){i=t})}).then(function(){return _structorCommons.commons.readDirectoryFlat(o).then(function(t){var n=t.dirs;if(!n||n.length<=0)throw Error("Modules directory is empty");return n})}).then(function(t){t.forEach(function(t){i.modules&&i.modules[t.name]&&r.push(t.name)})}).then(function(){return{namespacesSrcDirPath:e,existingNamespaceDirs:r}})}function installFromDir(t){var n=_path2.default.join(t,"structor-namespaces.json"),r=_path2.default.join(t,"modules"),e=_path2.default.join(t,"defaults"),o=_path2.default.join(t,"docs"),s=_path2.default.join(_structorCommons.config.appDirPath(),"modules"),i=_structorCommons.config.componentDefaultsDirPath(),u=_structorCommons.config.docsComponentsDirPath(),c=void 0,a=void 0;return _structorCommons.commons.readJson(n).then(function(t){c=t}).then(function(){return _structorCommons.storage.installDependencies(c.dependencies)}).then(function(){return _structorCommons.storage.getComponentTree()}).then(function(t){a=t;var n=[],e=a.reducersSourceCode,o=a.sagasSourceCode,s=void 0,i=void 0;return(0,_lodash.forOwn)(c.namespaces,function(t,u){s=_path2.default.join(r,u,"reducer.js"),i=_path2.default.join(r,u,"sagas.js"),n.push(_structorCommons.commons.isExisting(s).then(function(){return _structorCommons.commons.isExisting(i)}).then(function(){e=_structorCommons.gengine.injectReducer(e,t.reducerPropName,t.reducerPropName+"Reducer",_path2.default.join("modules",u,"reducer.js")),o=_structorCommons.gengine.injectSaga(o,u+"Sagas",_path2.default.join("modules",u,"sagas.js"))}))}),Promise.all(n).then(function(){return _structorCommons.commons.writeFile(a.reducersFilePath,e)}).then(function(){return _structorCommons.commons.writeFile(a.sagasFilePath,o)})}).then(function(){return _structorCommons.commons.readDirectoryFlat(r).then(function(t){var n=t.dirs;if(!n||n.length<=0)throw Error("Modules directory is empty");return n})}).then(function(t){var n=[];return t.forEach(function(t){var r=_path2.default.join(s,t.name);n.push(_structorCommons.commons.removeFile(r).then(function(){return _structorCommons.commons.copyFile(t.path,r)}))}),Promise.all(n)}).then(function(){return _structorCommons.commons.readDirectoryFlat(e).then(function(t){var n=t.dirs;if(!n||n.length<=0)throw Error("Defaults directory is empty");return n})}).then(function(t){var n=[],r=a.indexSourceCode;return t.forEach(function(t){var e=_path2.default.join(i,t.name);n.push(_structorCommons.commons.removeFile(e).then(function(){return _structorCommons.commons.copyFile(t.path,e)}).then(function(){return r=_structorCommons.gengine.injectNamespaceComponent(r,t.name,_path2.default.join("modules",t.name)),_structorCommons.commons.writeFile(a.indexFilePath,r)}))}),Promise.all(n)}).then(function(){return _structorCommons.commons.readDirectoryFlat(o).then(function(t){var n=t.dirs;if(!n||n.length<=0)throw Error("Docs directory is empty");return n})}).then(function(t){var n=[];return t.forEach(function(t){var r=_path2.default.join(u,t.name);n.push(_structorCommons.commons.removeFile(r).then(function(){return _structorCommons.commons.copyFile(t.path,r)}))}),Promise.all(n)}).then(function(){return cleanDistr()}).catch(function(t){return cleanDistr().then(function(){throw t})})}function getMarketList(){return client.get("https://raw.githubusercontent.com/ipselon/structor-market/master/index.json").then(function(t){return t})}function getGHRepoInfo(t,n){var r="https://api.github.com/repos/"+n+"/"+t;return client.get(r).then(function(r){return _extends({gitHubRepo:t,gitHubOwner:n},(0,_lodash.pick)(r,["description","html_url","stargazers_count","open_issues_count"]))}).then(function(t){return client.get(r+"/releases").then(function(n){var r=[];return n&&n.length>0&&n.forEach(function(t){r.push(_extends({},(0,_lodash.pick)(t,["name","tarball_url"])))}),Object.assign({},t,{releases:r})})}).then(function(t){return client.get(r+"/contents").then(function(n){var r=void 0;if(n&&n.length>0){var e=n.find(function(t){return t.name&&t.name.indexOf("screenshot")>=0});e&&(r=e.download_url)}return Object.assign({},t,{screenshotUrl:r})})}).catch(function(r){return console.log(r),{gitHubRepo:t,gitHubOwner:n,error:""+r}})}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])}return t};exports.cleanDistr=cleanDistr,exports.preInstall=preInstall,exports.installFromDir=installFromDir,exports.getMarketList=getMarketList,exports.getGHRepoInfo=getGHRepoInfo;var _path=require("path"),_path2=_interopRequireDefault(_path),_lodash=require("lodash"),_structorCommons=require("structor-commons"),_clientGH=require("../commons/clientGH.js"),client=_interopRequireWildcard(_clientGH),META_DISTR_DIR_NAME=".structor-namespaces-distr";