"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(n[o]=e[o]);return n.default=e,n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getDependentNamespaces(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=[];o=o.concat(n);var s=_structorCommons.gengine.combineAllModulesComponents(e,n),a=_structorCommons.gengine.getModelComponentList(e,s);if(a&&a.length>0){var c=a.filter(function(e){return!e.namespace});if(c&&c.length>0)throw Error("Component models are including components out of any namespace.");a.forEach(function(e){(0,_lodash.includes)(o,e.namespace)||(0,_lodash.includes)(r,e.namespace)||r.push(e.namespace)})}return _structorCommons.gengine.getModulesImports(e,n).then(function(n){return n&&n.length>0&&n.forEach(function(e){e&&!(0,_lodash.isEmpty)(e)&&(0,_lodash.forOwn)(e,function(e,n){var s=e.source;if(s&&s.length>0){var a=s.replace(/\\/g,"/");if(0!==s.indexOf(".")){var c=a.split("/");c&&c.length>0&&("modules"===c[0]?(0,_lodash.includes)(o,c[1])||(0,_lodash.includes)(r,c[1])||r.push(c[1]):(0,_lodash.includes)(t,c[0])||t.push(c[0]))}}})}),r.length>0?getDependentNamespaces(e,r,o,t):{depNamespaces:o,modules:t}})}function getAllDependencies(e){var n={dependencies:{packages:[]}},o=void 0;return _structorCommons.storage.getComponentTree().then(function(e){o=e}).then(function(){return getDependentNamespaces(o,e)}).then(function(e){var o=e.depNamespaces,t=e.modules;n.namespaces=o;var r=[];return t&&t.length>0&&t.forEach(function(e){r.push(_structorCommons.commons.getPackageVersion(e,_structorCommons.config.getProjectDir()).then(function(o){o&&n.dependencies.packages.push({name:e,version:o})}))}),Promise.all(r).then(function(){return n})})}function extractNamespaces(e,n,o){var t=_structorCommons.config.sandboxGeneratorDirPath(),r=_path2.default.join(_structorCommons.config.sandboxDirPath(),"modules"),s=o,a=_path2.default.join(s,"modules"),c=_path2.default.join(s,"defaults"),u=_path2.default.join(s,"docs"),i={namespaces:e,project:_structorCommons.config.getProjectConfig()},m=void 0,p={namespaces:{},dependencies:n},l=void 0;return _structorCommons.storage.getComponentTree().then(function(e){return i.index=e,l=e,gengineManager.process(t,i)}).then(function(e){var n=e.files;return _structorCommons.storage.saveGenerated({},n)}).then(function(){var n=[];return e.forEach(function(e){m=l.modules[e],m&&m.absolutePath&&n.push(_structorCommons.commons.copyFile(m.absolutePath,_path2.default.join(r,e)))}),Promise.all(n)}).then(function(){return sandboxCompilerManager.compileSandbox().catch(function(e){throw Error("It seems that some components include external components out of any namespace.\n\n\n "+e)})}).then(function(){var n=[],o=l.reducersSourceCode;return e.forEach(function(e){if(m=l.modules[e],m&&m.absolutePath){var t=m.reducerFilePath;if(t){var r=_structorCommons.gengine.getReducerPropertyName(o,m.reducerImportPath);p.namespaces[e]=p.namespaces[e]||{},p.namespaces[e].reducerPropName=r}n.push(_structorCommons.commons.copyFile(m.absolutePath,_path2.default.join(a,e)).then(function(){var n=_path2.default.join(_structorCommons.config.docsComponentsDirPath(),e);return _structorCommons.commons.copyFile(n,_path2.default.join(u,e))}).then(function(){var n=_path2.default.join(_structorCommons.config.componentDefaultsDirPath(),e);return _structorCommons.commons.copyFile(n,_path2.default.join(c,e))}))}}),Promise.all(n)}).then(function(){return _structorCommons.commons.writeJson(_path2.default.join(s,"structor-namespaces.json"),p)}).then(function(){return _structorCommons.commons.removeFile(_structorCommons.config.sandboxDirPath())})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDependentNamespaces=getDependentNamespaces,exports.getAllDependencies=getAllDependencies,exports.extractNamespaces=extractNamespaces;var _path=require("path"),_path2=_interopRequireDefault(_path),_lodash=require("lodash"),_structorCommons=require("structor-commons"),_gengine=require("../commons/gengine.js"),gengineManager=_interopRequireWildcard(_gengine),_sandboxCompilerManager=require("./sandboxCompilerManager.js"),sandboxCompilerManager=_interopRequireWildcard(_sandboxCompilerManager);